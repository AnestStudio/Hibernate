# Use Hibernate

<br />

Trong bài viết trước chúng ta đã cùng cài đặt và cấu hình Hibernate. Trong bài này, chúng ta sẽ tìm hiểu cách sử dụng `SessionFactory` để thực hiện các câu lệnh truy vấn đến database.

<br />

## 1. Create SessionFactory object

Như đã giới thiệu ở bài viết trước, `SessionFactory` là một __interface__ giúp tạo ra __session__ kết nối đến database bằng cách đọc các cấu hình trong Hibernate configuration.

`SessionFactory` là heavyweight, thread-safe object và được sử dụng thường xuyên nên chúng ta sẽ tạo một class __singleton__ `HibernateUtil` để sử dụng sau này.

<br />

### 1.1. `HibernateUtil` with `hibernate.cfg.xml` file

`HibernateUtil.java`

```java
package config;

import lombok.Getter;
import org.hibernate.SessionFactory;
import org.hibernate.boot.Metadata;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;
import org.hibernate.service.ServiceRegistry;

public class HibernateUtil {

    @Getter
    private static final SessionFactory sessionFactory = buildSessionFactory();

    private HibernateUtil() {
        super();
    }

    private static SessionFactory buildSessionFactory() {
        ServiceRegistry serviceRegistry = new StandardServiceRegistryBuilder()
                .configure() // Load hibernate.cfg.xml from resource folder by default
                .build();
        Metadata metadata = new MetadataSources(serviceRegistry).getMetadataBuilder().build();
        return metadata.getSessionFactoryBuilder().build();
    }
}
```

<br />

### 1.2. `HibernateUtil` with `hibernate.properties` file

`HibernateUtil.java`

```java
package config;

import entity.User;
import lombok.Getter;
import org.hibernate.SessionFactory;
import org.hibernate.boot.Metadata;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;
import org.hibernate.service.ServiceRegistry;

public class HibernateUtil {

    @Getter
    private static final SessionFactory sessionFactory = buildSessionFactory();

    private HibernateUtil() {
        super();
    }

    private static SessionFactory buildSessionFactory() {
        ServiceRegistry serviceRegistry = new StandardServiceRegistryBuilder()
                .loadProperties("hibernate.properties")
                .build();
        Metadata metadata = new MetadataSources(serviceRegistry)
                .getMetadataBuilder().build();
        return metadata.getSessionFactoryBuilder().build();
    }
}

```

Hoặc có thể viết như sau:

```java
package config;

import entity.User;
import lombok.Getter;
import org.hibernate.SessionFactory;
import org.hibernate.boot.Metadata;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;
import org.hibernate.service.ServiceRegistry;

public class HibernateUtil {

    @Getter
    private static final SessionFactory sessionFactory;

    private HibernateUtil() {
        super();
    }

    static  {
        ServiceRegistry serviceRegistry = new StandardServiceRegistryBuilder() //
                .loadProperties("hibernate.properties")
                .build();
        Metadata metadata = new MetadataSources(serviceRegistry)
                .addAnnotatedClass(User.class)
                .getMetadataBuilder().build();
        sessionFactory = metadata.getSessionFactoryBuilder().build();
    }
}
```

<br />

Cấu trúc project như sau:

```
Project/
   ├──src/  
   │  ├──main/
   │  │  ├──java/
   │  │  │  ├──config/
   │  │  │  │  └──HibernateUtil.java
   │  │  │  └──entity/
   │  │  │     └──User.java
   │  │  └──resources/
   │  │     └──hibernate.properties
   │  └──test/
   │     └──java/
   └──pom.xml
```

<br />

## 2. Use SessionFactory to perform queries to the database

Đầu tiên, chúng ta cần mở một __session__ để làm việc với Hibernate:
```java
Session session = HibernateUtil.getSessionFactory().openSession();
```

Để bắt đầu làm việc, chúng ta sẽ mở một Transaction mới:
```java
Transaction transaction = session.beginTransaction();
```

Hibernate hỗ trợ nhiều cách để truy vấn database, trong bài này chúng ta sẽ sử dụng HQL để truy vấn database. HQL có một chút khác biệt với SQL:

- SQL: Truy vấn dữ liệu trên các table và column.
- HQL: Truy vấn dữ liệu trên các entity và property.
  
Sau khi đã sử dụng xong, chúng ta cần gọi `commit()` để lưu mọi thay đổi xuống database.
```java
transaction.commit();
```

Sau khi `commit()` xong thì chúng ta cần `close()` __session__ để kết thúc phiên làm việc.
```java
session.close();
```

<br />

### 2.1. Insert new object

Chúng ta sẽ sử dụng `try-with-resource` để khởi tạo và tự động `close()` __session__.

```java
try (Session session = HibernateUtil.getSessionFactory().openSession()) {
    Transaction transaction = session.beginTransaction();

    Date currentDate = new Date();
    User user = new User();
    user.setUsername("AnhDT");
    user.setPassword("12345678");
    user.setCreatedAt(currentDate);
    user.setModifiedAt(currentDate);

    session.persist(user); // insert to database
    transaction.commit();
}
```

Chúng ta sẽ thấy câu SQL được sinh ra như sau ở console
```sql
[Hibernate] insert into [user] (created_at,modified_at,password,username) values (?,?,?,?)
```

### 2.2. Get object by primary key

Chúng ta có thể sử dụng 2 phương thức sau để lấy ra một đối tượng dựa trên primary key

- find(): the `EntityManager.find()` is JPA specified way. 
- get(): the `Session.get()` is hibernate API way.

```java
try (Session session = HibernateUtil.getSessionFactory().openSession()) {
    Transaction transaction = session.beginTransaction();

    User user = session.find(User.class, 1);
    System.out.println(user);

    transaction.commit();
}
```
Output
```java
User(userId=1, username=AnhDT, password=12345678, createdAt=2024-04-10 01:16:00.817, modifiedAt=2024-04-10 01:16:00.817)
```
SQL
```sql
[Hibernate] select u1_0.user_id,u1_0.created_at,u1_0.modified_at,u1_0.password,u1_0.username from [user] u1_0 where u1_0.user_id=?
```

<br />
  
