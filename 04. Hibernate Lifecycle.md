# Hibernate Lifecycle

<br />

Trong Hibernate, chúng ta sẽ tạo một đối tượng từ một Entity (thực thể) và lưu nó vào cơ sở dữ liệu hoặc chúng ta lấy dữ liệu từ cơ sở dữ liệu. Ở đây, mỗi Entity được liên kết với lifecycle (vòng đời), chịu sự quản lý của __Session__. Đối tượng Entity đi qua các giai đoạn khác nhau của lifecycle. Trong bài viết này, chúng ta sẽ cùng tìm hiểu về các giai đoạn này.

<br />

## 1. Overview

Khi nói về trạng thái (state) của object trong Hibernate, chúng ta nói một đối tượng có quan hệ với Session, nghĩa là Session có tham chiếu đến đối tượng đó, hay một cách khác là chịu sự quản lý của Session. Session được coi là một loại của Persistence Context.

<br />

### 1.1. Managing Entities

Ngoài việc map đối tượng Java đến bản ghi trong CSDL (ORM), thì có một vấn đề mà Hibernate phải quan tâm đến đó là quản lý các Entity. Cái ý niệm về __persistence context__ chính là giải pháp để giúp Hibernate làm được việc này. __Persistence context__ có thể coi là một _môi trường_ chứa toàn bộ các đối tượng mà ta tạo ra và lưu vào csdl trong mỗi session.

Một __Session__, hay là 1 phiên, là một giao dịch, có phạm vi tùy vào từng ứng dụng. Khi ta làm việc với DB thông qua một __Persistence Context__, mọi thực thể sẽ được gắn vào context này, mỗi bản ghi trong DB mà ta tương tác sẽ tương ứng với 1 thực thể trong context này.

Trong Hibernate, __Persistence Context__ được tạo ra nhờ `org.hibernate.Session`. Với JPA, __Persistence Context__ được thể hiện thông qua class `javax.persistence.EntityManager`. JPA là bộ đặc tả cho việc lưu dữ liệu vào DB dành cho ngôn ngữ Java, Hibernate sau này đã tuân theo bộ đặc tả đó. Khi đó nếu dùng combo JPA-Hibernate, thì __Persistence Context__ được tạo ra bởi EntityManager interface, thực tế sẽ là một lớp bọc lấy cái __Session__ object ở phía dưới. Nếu ta xài thẳng Session (ko xài EntityManager) thì sẽ có nhiều phương thức cho ta xài hơn, tiện dụng hơn.

<br />

### 1.2. Trạng thái của các Entity

Một đối tượng trong Hibernate có 1 trong 4 trạng thái:
- __Transient (Tạm thời)__: Đối tượng không có quan hệ với Session hiện tại của Hibernate. Đối tượng ở trạng thái này chưa từng gắn vào context, nó không có bản ghi tương ứng trong CSDL
- __Persistent (Bền vững)__: Đối tượng đang liên hệ với một context, tức là với một đối tượng Session và trạng thái của nó được đồng bộ với cơ sở dữ liệu khi mà ta commit cái Session.
- __Detached (Đã bị tách riêng ra)__: Đối tượng đã từng có trạng thái persistent nhưng hiện tại đã không còn giữ quan hệ với Session. Nếu nó không được attached trở lại, nó sẽ bị bộ gom rác của Java quét đi theo cơ chế thông thường. Một đối tượng đang trong session muốn đạt đươc trạng thái này thì có những cách là gọi hàm evict(), close Session hoặc làm combo thao tác: serialize/deserialize.
- __Removed (Đã bị xóa)__: tương tự như detached nhưng bản ghi tương ứng với đối tượng này trước đó đã bị xóa khỏi database.

<br />
